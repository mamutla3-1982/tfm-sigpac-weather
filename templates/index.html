<div id="det-panel" class="sidebar-section" style="display:none; padding:15px; background:#1a1a1a; border:1px solid #C8943A; margin-top:20px;">
    <h3 id="det-nombre" style="color:#C8943A;"></h3>
    <div id="det-texto" style="color:white; margin-bottom:20px;"></div>

    <canvas id="chartDiario" style="margin-bottom:20px;"></canvas>
    <canvas id="chartMensual" style="margin-bottom:20px;"></canvas>
    <canvas id="chartAnual" style="margin-bottom:20px;"></canvas>
    <canvas id="chartHist" style="margin-bottom:20px;"></canvas>

    <button onclick="document.getElementById('det-panel').style.display='none'">Cerrar</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let misGraficos = {}; // Para evitar errores de "canvas in use"

async function verDetalles(id) {
    const res = await fetch(`/api/parcelas/${id}/datos_completos`, {
        headers: {'Authorization': 'Bearer ' + localStorage.getItem('token')}
    });
    const result = await res.json();
    const d = result.data;

    document.getElementById('det-panel').style.display = 'block';
    document.getElementById('det-nombre').innerText = result.parcela;
    document.getElementById('det-texto').innerHTML = `
        <b>Provincia:</b> ${d.info_sigpac.provincia}<br>
        <b>Municipio:</b> ${d.info_sigpac.municipio}<br>
        <b>Cultivo:</b> ${d.info_sigpac.cultivo}
    `;

    // Pintar los 4 gráficos solicitados
    pintarGrafico('chartDiario', 'Lluvia Diaria (mm)', d.graficos.diario, '#C8943A');
    pintarGrafico('chartMensual', 'Acumulado Mensual', d.graficos.mensual, '#2ecc71');
    pintarGrafico('chartAnual', 'Acumulado Anual', d.graficos.anual, '#3498db');
    pintarGrafico('chartHist', 'Histórico 10 años', d.graficos.historico, '#e74c3c');
}

function pintarGrafico(id, label, puntos, color) {
    const ctx = document.getElementById(id).getContext('2d');
    if (misGraficos[id]) { misGraficos[id].destroy(); }

    misGraficos[id] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: puntos.map(p => p.f),
            datasets: [{
                label: label,
                data: puntos.map(p => p.v),
                borderColor: color,
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            scales: {
                y: { ticks: {color: 'white'} },
                x: { ticks: {color: 'white'} }
            },
            plugins: { legend: { labels: {color: 'white'} } }
        }
    });
}
</script>
