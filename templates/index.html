<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGPAC Weather Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="manifest" href="/static/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --agro: #2ecc71; --glass: rgba(255, 255, 255, 0.12); }
        body { 
            margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?auto=format&fit=crop&w=1920');
            background-size: cover; background-attachment: fixed; color: white;
        }
        .sidebar { width: 380px; background: var(--glass); backdrop-filter: blur(15px); padding: 20px; overflow-y: auto; border-right: 1px solid rgba(255,255,255,0.1); }
        #map { flex: 1; }
        .card { background: rgba(0,0,0,0.4); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        input { width: 100%; padding: 10px; margin: 5px 0; border-radius: 6px; border: none; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border-radius: 6px; border: none; background: var(--agro); color: white; font-weight: bold; cursor: pointer; }
        .chart-box { background: white; border-radius: 8px; padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>üåæ SIGPAC Weather</h2>
        <div id="auth-ui">
            <input id="email_login" placeholder="Email o Usuario">
            <input id="pass_login" type="password" placeholder="Contrase√±a">
            <button onclick="doLogin()">Entrar</button>
        </div>
        <div id="app-ui" style="display:none">
            <div class="card">
                <h4>üìç Nueva Parcela</h4>
                <input id="p_nom" placeholder="Nombre Parcela">
                <input id="p_prov" placeholder="Provincia (Auto)" readonly>
                <input id="p_mun" placeholder="Municipio (Auto)" readonly>
                <button onclick="saveParcela()">Guardar Parcela</button>
            </div>
            <div id="lista-parcelas"></div>
        </div>
        <div id="detalles-ui" style="display:none">
            <button onclick="backToMap()" style="background:#444; margin-bottom:10px">‚¨Ö Volver</button>
            <h3 id="det_titulo"></h3>
            <div class="chart-box"><canvas id="cDiario"></canvas></div>
            <div class="chart-box"><canvas id="cMensual"></canvas></div>
            <div class="chart-box"><canvas id="cAnual"></canvas></div>
            <div class="chart-box"><canvas id="cHist"></canvas></div>
        </div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script>
        var map = L.map('map').setView([37.8, -4.7], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var drawnItems = new L.FeatureGroup().addTo(map);
        var drawControl = new L.Control.Draw({ draw: { polygon: true, circle: false, marker: false, polyline: false, circlemarker: false }, edit: { featureGroup: drawnItems } }).addTo(map);

        let lastCenter = null;
        map.on('draw:created', function (e) {
            drawnItems.clearLayers();
            drawnItems.addLayer(e.layer);
            lastCenter = e.layer.getBounds().getCenter();
            // Autocompletado Geocoding
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lastCenter.lat}&lon=${lastCenter.lng}`)
                .then(r => r.json()).then(data => {
                    document.getElementById('p_prov').value = data.address.state || '';
                    document.getElementById('p_mun').value = data.address.city || data.address.town || '';
                });
        });

        function verGraficos(id) {
            fetch(`/api/parcelas/${id}`, { headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`} })
                .then(r => r.json()).then(data => {
                    document.getElementById('app-ui').style.display = 'none';
                    document.getElementById('detalles-ui').style.display = 'block';
                    document.getElementById('det_titulo').innerText = data.parcela.nombre;
                    const m = data.parcela.meteo;
                    renderC('cDiario', 'Diaria', m.diario);
                    renderC('cMensual', 'Mensual', m.mensual);
                    renderC('cAnual', 'Anual', m.anual);
                    renderC('cHist', 'Hist√≥rico', m.historico);
                });
        }

        function renderC(id, label, datos) {
            new Chart(document.getElementById(id), {
                type: 'line',
                data: { labels: datos.map(d => d.f), datasets: [{ label: label, data: datos.map(d => d.v), borderColor: '#2ecc71' }] }
            });
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js');
        }
    </script>
</body>
</html>
