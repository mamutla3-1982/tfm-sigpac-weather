<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>TFM SIGPAC Weather</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- Leaflet Draw -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
}

#map {
    height: 80vh;
    width: 100%;
}

.header {
    padding: 10px;
    background: #1e3d59;
    color: white;
}

.info-panel {
    padding: 10px;
    background: #f4f4f4;
}

button {
    padding: 8px 12px;
    margin: 5px;
    cursor: pointer;
}
</style>
</head>

<body>

<div class="header">
    <h2>üåæ SIGPAC Weather - Gesti√≥n de Parcelas</h2>
    <button onclick="guardarParcela()">Guardar Parcela</button>
    <button onclick="cerrarSesion()">Cerrar sesi√≥n</button>
</div>

<div id="map"></div>

<div class="info-panel">
    <p><strong>√Årea calculada:</strong> <span id="area">0</span> ha</p>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Draw -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>

// ===============================
// 1Ô∏è‚É£ Crear mapa
// ===============================
const map = L.map('map').setView([40.0, -3.5], 6);

// OpenStreetMap base
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
}).addTo(map);

// ===============================
// 2Ô∏è‚É£ Capa SIGPAC WMS
// ===============================
const sigpacLayer = L.tileLayer.wms("https://sigpac.mapa.es/fega/servicios/wms", {
    layers: "PARCELA",
    format: "image/png",
    transparent: true,
    version: "1.3.0"
}).addTo(map);

// ===============================
// 3Ô∏è‚É£ Dibujo de pol√≠gonos
// ===============================
const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

const drawControl = new L.Control.Draw({
    edit: {
        featureGroup: drawnItems
    },
    draw: {
        polygon: true,
        rectangle: false,
        circle: false,
        marker: false,
        polyline: false,
        circlemarker: false
    }
});

map.addControl(drawControl);

let currentGeoJSON = null;

// ===============================
// 4Ô∏è‚É£ Evento cuando dibuja
// ===============================
map.on(L.Draw.Event.CREATED, function (event) {
    drawnItems.clearLayers();
    const layer = event.layer;
    drawnItems.addLayer(layer);

    currentGeoJSON = layer.toGeoJSON();

    calcularArea(layer);
});

// ===============================
// 5Ô∏è‚É£ Calcular √°rea autom√°tica
// ===============================
function calcularArea(layer) {
    const latlngs = layer.getLatLngs()[0];

    const geojson = layer.toGeoJSON();
    const area_m2 = turf.area(geojson);
    const area_ha = area_m2 / 10000;

    document.getElementById("area").innerText = area_ha.toFixed(2);
}

// ===============================
// 6Ô∏è‚É£ Guardar parcela
// ===============================
async function guardarParcela() {

    if (!currentGeoJSON) {
        alert("Dibuja una parcela primero");
        return;
    }

    const nombre = prompt("Nombre de la parcela:");

    const response = await fetch("/api/parcelas", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("token")
        },
        body: JSON.stringify({
            nombre: nombre,
            superficie: document.getElementById("area").innerText,
            geometria: currentGeoJSON
        })
    });

    if (response.ok) {
        alert("Parcela guardada correctamente");
    } else {
        alert("Error al guardar");
    }
}

// ===============================
// 7Ô∏è‚É£ Cerrar sesi√≥n
// ===============================
function cerrarSesion() {
    localStorage.removeItem("token");
    window.location.href = "/";
}

</script>

<!-- Turf.js para c√°lculo de √°rea -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

</body>
</html>
