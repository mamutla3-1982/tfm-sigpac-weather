<div id="det-panel" style="display:none; padding: 15px; background: #222; border: 1px solid #C8943A; border-radius: 10px; margin-top: 15px;">
    <h3 id="det-nombre" style="color: #C8943A;"></h3>
    <div id="det-texto" style="color: white; font-size: 13px; margin-bottom: 20px;"></div>
    
    <div style="margin-bottom: 20px;"><canvas id="chartDiario"></canvas></div>
    <div style="margin-bottom: 20px;"><canvas id="chartMensual"></canvas></div>
    <div style="margin-bottom: 20px;"><canvas id="chartAnual"></canvas></div>
    <div style="margin-bottom: 20px;"><canvas id="chartHist"></canvas></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// TU FUNCIÓN (Aumentada para no duplicar gráficos)
async function verDetalles(id) {
    const res = await fetch(`/api/parcelas/${id}/datos_completos`, {
        headers: {'Authorization': 'Bearer ' + localStorage.getItem('token')}
    });
    const result = await res.json();
    const d = result.data;

    document.getElementById('det-panel').style.display = 'block';
    document.getElementById('det-nombre').innerText = result.parcela;
    document.getElementById('det-texto').innerHTML = `
        Provincia: ${d.info_sigpac.provincia}<br>
        Municipio: ${d.info_sigpac.municipio}<br>
        Cultivo: ${d.info_sigpac.cultivo}
    `;

    pintarGrafico('chartDiario', 'Lluvia Diaria (mm)', d.graficos.diario, '#C8943A');
    pintarGrafico('chartMensual', 'Acumulado Mensual', d.graficos.mensual, '#2ecc71');
    pintarGrafico('chartAnual', 'Acumulado Anual', d.graficos.anual, '#3498db');
    pintarGrafico('chartHist', 'Histórico 10 años', d.graficos.historico, '#e74c3c');
}

function pintarGrafico(id, label, puntos, color) {
    const ctx = document.getElementById(id).getContext('2d');
    
    // Aumento: Destruir el gráfico anterior si existe para que no parpadee
    if (window[id + '_chart']) { window[id + '_chart'].destroy(); }

    window[id + '_chart'] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: puntos.map(p => p.f),
            datasets: [{
                label: label,
                data: puntos.map(p => p.v),
                borderColor: color,
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            scales: {
                y: { ticks: {color: 'white'} },
                x: { ticks: {color: 'white'} }
            },
            plugins: { legend: { labels: {color: 'white'} } }
        }
    });
}
</script>
